<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OpenBrowserAgent - Terminal Interface</title>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Monaco', 'Menlo', 'Consolas', 'Courier New', monospace;
            background-color: #1a1a1a;
            color: #cccccc;
            line-height: 1.4;
            height: 100vh;
            padding: 0;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        .terminal-header {
            background: #222222;
            border-bottom: 1px solid #444444;
            padding: 10px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
        }

        .ascii-title {
            font-family: monospace;
            white-space: pre;
            font-size: 12px;
            line-height: 1.2;
            color: #ffffff;
            margin: 0;
            letter-spacing: 0.5px;
        }

        .status-bar {
            display: flex;
            gap: 15px;
            font-size: 12px;
        }

        .status-item {
            padding: 4px 8px;
            background: #222222;
            border-radius: 3px;
            border: 1px solid #444444;
        }

        .status-connected {
            color: #cccccc;
        }

        .status-disconnected {
            color: #888888;
        }

        #cwd-input {
            background: #222222;
            border: 1px solid #444444;
            color: #cccccc;
            font-family: 'Monaco', 'Menlo', 'Consolas', 'Courier New', monospace;
            font-size: 12px;
            padding: 2px 5px;
            width: 200px;
            border-radius: 3px;
            outline: none;
        }

        #cwd-input::placeholder {
            color: #888888;
            opacity: 0.8;
        }

        #cwd-input:focus {
            border-color: #666666;
            box-shadow: 0 0 0 1px #444444;
        }

        #cwd-input-container {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .container {
            display: flex;
            width: 100%;
            flex: 1;
            overflow: hidden;
        }

        .main-terminal {
            flex: 3;
            display: flex;
            flex-direction: column;
            background: #1a1a1a;
            border-right: 1px solid #444444;
            min-width: 300px;
        }
        
        .right-panel {
            flex: 2;
            display: flex;
            flex-direction: column;
            min-width: 350px;
            max-width: 700px;
        }
        
        .image-viewer {
            flex: 3;
            background: #1a1a1a;
            border-bottom: 1px solid #444444;
            display: flex;
            flex-direction: column;
            min-height: 300px;
        }
        
        .image-viewer-title {
            padding: 8px 12px;
            background: #222222;
            border-bottom: 1px solid #444444;
            color: #cccccc;
            font-size: 13px;
            font-weight: bold;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            flex-shrink: 0;
        }
        
        .image-viewer-content {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 10px;
            overflow: hidden;
            position: relative;
            min-height: 200px;
        }
        
        .live-image {
            max-width: 100%;
            max-height: 100%;
            width: auto;
            height: auto;
            object-fit: contain;
            border: 2px solid #444444;
            border-radius: 5px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.5);
            transition: border-color 0.3s ease, box-shadow 0.3s ease, transform 0.3s ease, opacity 0.3s ease;
            opacity: 1;
        }
        
        .live-image.fade-out {
            opacity: 0.3;
        }
        
        .live-image:hover {
            border-color: #666666;
            box-shadow: 0 6px 16px rgba(0, 0, 0, 0.6);
        }
        
        .live-image.fullsize {
            max-width: 90vw;
            max-height: 90vh;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) scale(0.95);
            z-index: 1000;
            background: #1a1a1a;
            padding: 10px;
            border-radius: 5px;
            box-shadow: 0 0 0 100vmax rgba(0, 0, 0, 0.9);
            cursor: pointer;
        }
        
        .live-image.fullsize:hover {
            transform: translate(-50%, -50%) scale(1);
        }
        
        .no-image-placeholder {
            color: #666666;
            font-style: italic;
            text-align: center;
            padding: 20px;
            font-size: 13px;
        }

        .terminal-output {
            flex: 1;
            overflow-y: auto;
            padding: 15px 15px 80px 15px;
            font-family: 'Monaco', 'Menlo', 'Consolas', monospace;
            font-size: 13px;
            line-height: 1.4;
        }

        .event-line {
            margin-bottom: 6px;
            padding: 4px 8px;
            border-left: 2px solid #444444;
            transition: all 0.2s;
            cursor: pointer;
            position: relative;
        }

        .event-line:hover {
            background: #222222;
            border-left-color: #666666;
        }

        .event-line.collapsed {
            max-height: 24px;
            overflow: hidden;
        }
        
        .event-line.collapsed .event-full-content {
            display: none;
        }
        
        .event-header-summary {
            color: #888888;
            font-style: italic;
            margin-left: 0;
            margin-right: 6px;
        }
        
        .event-line.expanded .event-header-summary {
            display: none;
        }

        .event-line.expanded {
            background: #222222;
            border-left-color: #666666;
        }

        .event-header {
            display: flex;
            align-items: center;
            margin-bottom: 4px;
        }

        .event-type {
            font-weight: bold;
            color: #aaaaaa;
            margin-right: 6px;
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .event-timestamp {
            color: #666666;
            font-size: 10px;
            margin-right: 8px;
        }

        .expand-toggle {
            color: #666666;
            font-size: 10px;
            margin-left: auto;
            cursor: pointer;
            user-select: none;
        }

        .expand-toggle:hover {
            color: #aaaaaa;
        }

        .event-content {
            white-space: normal;
            font-family: 'Monaco', 'Menlo', 'Consolas', monospace;
            font-size: 12px;
            color: #cccccc;
            line-height: 1.4;
            text-align: left;
            word-break: break-word;
            text-indent: 0;
            padding-left: 0;
            margin-left: 0;
        }

        .event-image {
            margin-top: 10px;
            max-width: 800px;
            max-height: 600px;
            width: auto;
            height: auto;
            border: 1px solid #444444;
            border-radius: 3px;
            cursor: pointer;
            transition: transform 0.2s ease, border-color 0.2s ease;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
        }
        
        .event-image:hover {
            border-color: #666666;
            transform: scale(1.01);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.4);
        }
        
        .event-image.fullsize {
            max-width: 100%;
            max-height: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) scale(0.95);
            z-index: 1000;
            background: #1a1a1a;
            padding: 10px;
            border-radius: 5px;
            box-shadow: 0 0 0 100vmax rgba(0, 0, 0, 0.8);
        }
        
        .event-image.fullsize:hover {
            transform: translate(-50%, -50%) scale(1);
        }
        
        .image-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            z-index: 999;
            display: none;
        }

        .event-meta {
            color: #666666;
            font-size: 10px;
            margin-bottom: 5px;
            font-family: monospace;
        }
        
        .event-meta small {
            opacity: 0.7;
        }

        .prompt-line {
            color: #cccccc;
        }

        .prompt-line::before {
            content: "> ";
            color: #cccccc;
        }

        .input-area {
            position: sticky;
            bottom: 0;
            left: 0;
            right: 0;
            border-top: 1px solid #444444;
            padding: 15px 20px;
            background: #222222;
            display: flex;
            align-items: center;
            z-index: 100;
        }

        .input-prompt {
            color: #cccccc;
            margin-right: 10px;
            user-select: none;
        }

        .command-input {
            flex: 1;
            background: transparent;
            border: none;
            color: #cccccc;
            font-family: 'Monaco', 'Menlo', 'Consolas', monospace;
            font-size: 13px;
            outline: none;
            caret-color: #cccccc;
        }

        .command-input::placeholder {
            color: #666666;
        }

        .send-button {
            background: #222222;
            color: #cccccc;
            border: 1px solid #444444;
            padding: 6px 15px;
            font-family: 'Monaco', 'Menlo', 'Consolas', monospace;
            font-size: 12px;
            cursor: pointer;
            margin-left: 10px;
            transition: all 0.2s;
        }

        .send-button:hover:not(:disabled) {
            background: #444444;
            color: #ffffff;
            border-color: #444444;
        }

        .send-button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .sidebar {
            flex: 2;
            background: #222222;
            padding: 15px;
            overflow-y: auto;
            min-height: 300px;
        }

        .sidebar-section {
            margin-bottom: 18px;
        }

        .sidebar-title {
            color: #cccccc;
            font-size: 13px;
            margin-bottom: 8px;
            padding-bottom: 4px;
            border-bottom: 1px solid #444444;
        }

        .connection-info {
            background: #222222;
            padding: 8px;
            border-radius: 3px;
            border: 1px solid #444444;
            margin-bottom: 12px;
        }

        .info-line {
            margin-bottom: 5px;
            font-size: 11px;
        }

        .info-label {
            color: #666666;
            display: inline-block;
            width: 80px;
        }

        .info-value {
            color: #cccccc;
            word-break: break-all;
            max-width: 250px;
            display: inline-block;
            vertical-align: middle;
        }
        
        .refresh-button {
            margin-left: 8px;
            font-size: 10px;
            padding: 2px 6px;
            background: #333333;
            border: 1px solid #555555;
            color: #cccccc;
            border-radius: 3px;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .refresh-button:hover {
            background: #444444;
            border-color: #666666;
            color: #ffffff;
        }
        
        .refresh-button:active {
            background: #222222;
            transform: scale(0.95);
        }

        .event-stats {
            background: #222222;
            padding: 8px;
            border-radius: 3px;
            border: 1px solid #444444;
        }

        .stat-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
            font-size: 11px;
        }

        .stat-label {
            color: #666666;
        }

        .stat-value {
            color: #cccccc;
        }

        .scrollbar {
            scrollbar-width: thin;
            scrollbar-color: #444444 #222222;
        }

        .scrollbar::-webkit-scrollbar {
            width: 8px;
        }

        .scrollbar::-webkit-scrollbar-track {
            background: #222222;
        }

        .scrollbar::-webkit-scrollbar-thumb {
            background: #444444;
            border-radius: 4px;
        }

        .scrollbar::-webkit-scrollbar-thumb:hover {
            background: #555555;
        }

        .blink {
            animation: blink 1s infinite;
        }

        @keyframes blink {
            0%, 100% { opacity: 1; }
            50% { opacity: 0; }
        }

        .hidden {
            display: none !important;
        }

        .loading-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border: 2px solid #444444;
            border-top-color: #cccccc;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 8px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        /* Responsive design for screens smaller than 1200px */
        @media (max-width: 1200px) {
            .event-image {
                max-width: 600px;
                max-height: 450px;
            }
        }
        
        /* Responsive design for screens smaller than 900px */
        @media (max-width: 900px) {
            .event-image {
                max-width: 500px;
                max-height: 375px;
            }
            
            .container {
                flex-direction: column;
                height: auto;
                min-height: 100vh;
            }
            
            .main-terminal {
                border-right: none;
                border-bottom: 1px solid #444444;
            }
            
            .sidebar {
                width: 100%;
                border-left: none;
                border-top: 1px solid #444444;
            }
            
            .input-area {
                right: 0;
            }
        }
        
        /* Responsive design for medium screens (tablets and small laptops) */
        @media (max-width: 900px) {
            .main-terminal {
                min-width: 280px;
            }
            
            .right-panel {
                min-width: 300px;
            }
            
            .container {
                flex-direction: column;
            }
            
            .main-terminal {
                border-right: none;
                border-bottom: 1px solid #444444;
                min-height: 40vh;
            }
            
            .right-panel {
                min-height: 60vh;
            }
        }
        
        /* Responsive design for screens smaller than 600px */
        @media (max-width: 600px) {
            .event-image {
                max-width: 100%;
                max-height: 300px;
            }
            
            .terminal-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 10px;
            }
            
            .ascii-title {
                font-size: 10px;
            }
            
            .status-bar {
                width: 100%;
                justify-content: space-between;
            }
            
            #cwd-input {
                width: 100%;
            }
        }
        
        /* Configuration Page Styles */
        .config-page {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: #1a1a1a;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 2000;
            overflow-y: auto;
            padding: 20px;
        }
        
        .config-container {
            background: #222222;
            border: 1px solid #444444;
            border-radius: 8px;
            padding: 30px;
            max-width: 600px;
            width: 100%;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.5);
            position: relative;
        }
        
        .config-header {
            text-align: center;
            margin-bottom: 30px;
        }
        
        .config-header h1 {
            color: #ffffff;
            font-size: 24px;
            margin-bottom: 10px;
        }
        
        .config-subtitle {
            color: #888888;
            font-size: 14px;
        }
        
        .config-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            border-bottom: 1px solid #444444;
            padding-bottom: 10px;
        }
        
        .config-tab {
            background: #1a1a1a;
            border: 1px solid #444444;
            color: #cccccc;
            padding: 8px 20px;
            cursor: pointer;
            border-radius: 4px 4px 0 0;
            font-size: 13px;
            transition: all 0.2s;
        }
        
        .config-tab:hover {
            background: #333333;
        }
        
        .config-tab.active {
            background: #333333;
            border-bottom-color: #333333;
            color: #ffffff;
        }
        
        .config-tab-content {
            padding: 20px 0;
        }
        
        .config-form {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }
        
        .form-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        
        .form-group label {
            color: #cccccc;
            font-size: 14px;
            font-weight: bold;
        }
        
        .form-group input {
            background: #1a1a1a;
            border: 1px solid #444444;
            color: #ffffff;
            padding: 10px;
            border-radius: 4px;
            font-size: 14px;
            font-family: 'Monaco', 'Menlo', 'Consolas', monospace;
        }
        
        .form-group input:focus {
            outline: none;
            border-color: #666666;
        }
        
        .form-group input::placeholder {
            color: #666666;
        }
        
        .help-text {
            color: #888888;
            font-size: 12px;
            font-style: italic;
        }
        
        .required {
            color: #ff6b6b;
        }
        
        .form-actions {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }
        
        .btn-primary {
            background: #4a90e2;
            color: #ffffff;
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            font-weight: bold;
            transition: background 0.2s;
        }
        
        .btn-primary:hover {
            background: #357abd;
        }
        
        .btn-success {
            background: #4caf50;
            color: #ffffff;
            padding: 12px 24px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            transition: background 0.2s;
            width: 100%;
        }
        
        .btn-success:hover {
            background: #45a049;
        }
        
        .config-footer {
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid #444444;
        }
        
        .settings-btn {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #444444;
            border: 1px solid #666666;
            color: #ffffff;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
            z-index: 1000;
        }
        
        .settings-btn:hover {
            background: #666666;
            transform: rotate(90deg);
        }
        
        /* Main Interface Container */
        #main-interface {
            display: flex;
            flex-direction: column;
            flex: 1;
            width: 100%;
            overflow: hidden;
        }
    </style>
</head>
<body>
    <div id="main-interface">
    <div class="terminal-header">
        <div class="ascii-title">
    ,----..   ,-.----.                      ,--.                         ,----..                                                     
   /   /   \  \    /  \      ,---,.       ,--.'|    ,---,. ,-.----.     /   /   \             .---.  .--.--.       ,---,.,-.----.    
  /   .     : |   :    \   ,'  .' |   ,--,:  : |  ,'  .'  \\    /  \   /   .     :           /. ./| /  /    '.   ,'  .' |\    /  \   
 .   /   ;.  \|   |  .\ :,---.'   |,`--.'`|  ' :,---.' .' |;   :    \ .   /   ;.  \      .--'.  ' ;|  :  /`. / ,---.'   |;   :    \  
.   ;   /  ` ;.   :  |: ||   |   .'|   :  :  | ||   |  |: ||   | .\ :.   ;   /  ` ;     /__./ \ : |;  |  |--`  |   |   .'|   | .\ :  
;   |  ; \ ; ||   |   \ ::   :  |-,:   |   \ | ::   :  :  /.   : |: |;   |  ; \ ; | .--'.  '   \' .|  :  ;_    :   :  |-,.   : |: |  
|   :  | ; | '|   : .   /:   |  ;/||   : '  '; |:   |    ; |   |  \ :|   :  | ; | '/___/ \ |    ' ' \  \    `. :   |  ;/||   |  \ :  
.   |  ' ' ' :;   | |`-' |   :   .''   ' ;.    ;|   :     \|   : .  /.   |  ' ' ' :;   \  \;      :  `----.   \|   :   .'|   : .  /  
'   ;  \; /  ||   | ;    |   |  |-,|   | | \   ||   |   . |;   | |  \'   ;  \; /  | \   ;  `      |  __ \  \  ||   |  |-,;   | |  \  
 \   \  ',  / :   ' |    '   :  ;/|'   : |  ; .''   :  '; ||   | ;\  \\   \  ',  /   .   \    .\  ; /  /`--'  /'   :  ;/||   | ;\  \ 
  ;   :    /  :   : :    |   |    \|   | '`--'  |   |  | ; :   ' | \.' ;   :    /     \   \   ' \ |'--'.     / |   |    \:   ' | \.' 
   \   \ .'   |   | :    |   :   .''   : |      |   :   /  :   : :-'    \   \ .'       :   '  |--"   `--'---'  |   :   .':   : :-'   
    `---`     `---'.|    |   | ,'  ;   |.'      |   | ,'   |   |.'       `---`          \   \ ;                |   | ,'  |   |.'     
                `---`    `----'    '---'        `----'     `---'                         '---"                 `----'    `---'       
        </div>
        <div class="status-bar">
            <div class="status-item" id="server-status">SERVER: <span class="status-disconnected">DISCONNECTED</span></div>
            <div class="status-item" id="browser-status">BROWSER: <span class="status-disconnected">NOT CONNECTED</span></div>
            <div class="status-item" id="event-count">EVENTS: <span>0</span></div>
            <div class="status-item" id="cwd-input-container">
                <label for="cwd-input">CWD:</label>
                <input type="text" id="cwd-input" placeholder="Enter working directory" value="/tmp">
            </div>
            <div class="status-item">
                <button onclick="openConfigPage()" style="background: #333333; border: 1px solid #666666; color: #cccccc; padding: 4px 12px; cursor: pointer; border-radius: 3px; font-size: 11px;" title="Configure LLM Settings">
                    ⚙️ Settings
                </button>
            </div>
        </div>
    </div>
    
    <div class="container">
        <div class="main-terminal">
            <div class="terminal-output scrollbar" id="terminal-output">
                <!-- Event lines will be dynamically added here -->
                <div class="event-line expanded" data-type="SystemEvent" data-source="system">
                    <div class="event-header">
                        <span class="event-type" style="color: #666666;">SYSTEM</span>
                        <span class="event-timestamp" id="current-time"></span>
                        <span class="expand-toggle" onclick="toggleEvent(this)">[collapse]</span>
                    </div>
                    <div class="event-content">
                        <div class="prompt-line">OpenBrowserAgent Terminal Interface v1.0</div>
                        <div class="prompt-line">Type commands below to control the browser via AI</div>
                        <div class="prompt-line">System ready. Waiting for input...</div>
                    </div>
                </div>
            </div>
            
            <div class="input-area">
                <div class="input-prompt blink">></div>
                <input type="text" class="command-input" id="command-input" placeholder="Type a command (e.g., 'open google.com') and press Enter" autofocus>
                <button class="send-button" id="send-button" onclick="sendCommand()">SEND</button>
            </div>
        </div>
        
        <div class="right-panel">
            <div class="image-viewer">
                <div class="image-viewer-title">LIVE VIEW</div>
                <div class="image-viewer-content" id="image-viewer-content">
                    <div class="no-image-placeholder" id="no-image-placeholder">
                        No image available<br>
                        <span style="font-size: 12px; color: #555555;">Screenshots will appear here</span>
                    </div>
                    <!-- Live image will be dynamically added here -->
                </div>
                <div class="image-viewer-title" style="font-size: 12px; text-align: center;">OpenBrowser's Chrome</div>
            </div>
            
            <div class="sidebar scrollbar">
                <div class="sidebar-section">
                    <div class="sidebar-title">CONNECTION INFO</div>
                    <div class="connection-info">
                        <div class="info-line">
                            <span class="info-label">Server:</span>
                            <span class="info-value" id="server-url">http://127.0.0.1:8765</span>
                        </div>
                        <div class="info-line">
                            <span class="info-label">Status:</span>
                            <span class="info-value" id="connection-status">Not connected</span>
                        </div>
                        <div class="info-line">
                            <span class="info-label">Conversation:</span>
                            <span class="info-value" id="conversation-id">None</span>
                            <button class="refresh-button" id="refresh-conversation-btn" title="Refresh conversation ID" onclick="refreshConversationId()">↻</button>
                        </div>
                    </div>
                </div>
                
                <div class="sidebar-section">
                    <div class="sidebar-title">QUICK COMMANDS</div>
                    <div class="event-stats">
                        <div class="stat-item">
                            <button class="send-button" style="width: 100%; margin: 5px 0; font-size: 11px;" onclick="setCommand('star https://github.com/softpudding/OpenBrowser'); document.getElementById('command-input').focus();">star https://github.com/softpudding/OpenBrowser</button>
                        </div>
                        <div class="stat-item">
                            <button class="send-button" style="width: 100%; margin: 5px 0; font-size: 11px;" onclick="clearTerminal()">CLEAR TERMINAL</button>
                        </div>
                    </div>
                </div>
                
                <div class="sidebar-section">
                    <div class="sidebar-title">EVENT STATISTICS</div>
                    <div class="event-stats">
                        <div class="stat-item">
                            <span class="stat-label">Total Events:</span>
                            <span class="stat-value" id="stat-total">0</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label">Message Events:</span>
                            <span class="stat-value" id="stat-message">0</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label">Action Events:</span>
                            <span class="stat-value" id="stat-action">0</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label">Observation Events:</span>
                            <span class="stat-value" id="stat-observation">0</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label">Errors:</span>
                            <span class="stat-value" id="stat-error">0</span>
                        </div>
                    </div>
                </div>
                
                <div class="sidebar-section">
                    <div class="sidebar-title">FILTER SETTINGS</div>
                    <div class="event-stats">
                        <div class="stat-item">
                            <span class="stat-label">Show System Events:</span>
                            <span class="stat-value">
                                <input type="checkbox" id="filter-system" checked onchange="updateEventVisibility()">
                            </span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label">Show User Messages:</span>
                            <span class="stat-value">
                                <input type="checkbox" id="filter-user-message" onchange="updateEventVisibility()" checked>
                            </span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label">Auto-expand Events:</span>
                            <span class="stat-value">
                                <input type="checkbox" id="auto-expand" checked>
                            </span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    </div>  <!-- End of main-interface -->
    
    <!-- Configuration Page -->
    <div id="config-page" class="config-page" style="display: none;">
        <div class="config-container">
            <button onclick="hideConfigPage()" style="position: absolute; top: 15px; right: 15px; background: #444444; border: 1px solid #666666; color: #cccccc; width: 30px; height: 30px; border-radius: 50%; cursor: pointer; font-size: 18px; display: flex; align-items: center; justify-content: center; transition: all 0.2s;" title="Close Settings" onmouseover="this.style.background='#666666'" onmouseout="this.style.background='#444444'">
                ✕
            </button>
            <div class="config-header">
                <h1>OpenBrowser Configuration</h1>
                <p class="config-subtitle">Configure your LLM API settings to get started</p>
            </div>
            
            <div class="config-tabs">
                <button class="config-tab active" onclick="switchConfigTab('llm')">LLM Configs</button>
                <button class="config-tab" onclick="switchConfigTab('cwd')">Default CWD</button>
            </div>
            
            <div id="config-llm-tab" class="config-tab-content active">
                <form onsubmit="saveLLMConfig(event)" class="config-form">
                    <div class="form-group">
                        <label for="config-model">Model:</label>
                        <input type="text" id="config-model" 
                               placeholder="dashscope/qwen3.5-plus" 
                               value="dashscope/qwen3.5-plus">
                        <small class="help-text">Default: dashscope/qwen3.5-plus</small>
                    </div>
                    
                    <div class="form-group">
                        <label for="config-base-url">Base URL:</label>
                        <input type="text" id="config-base-url" 
                               placeholder="https://dashscope.aliyuncs.com/compatible-mode/v1"
                               value="https://dashscope.aliyuncs.com/compatible-mode/v1">
                        <small class="help-text">Default: https://dashscope.aliyuncs.com/compatible-mode/v1</small>
                    </div>
                    
                    <div class="form-group">
                        <label for="config-api-key">API Key <span class="required">*</span>:</label>
                        <input type="password" id="config-api-key" 
                               placeholder="Enter your API key">
                        <small class="help-text">Your API key is required and will be stored locally</small>
                    </div>
                    
                    <div class="form-actions">
                        <button type="submit" class="btn-primary">Save LLM Config</button>
                    </div>
                </form>
            </div>
            
            <div id="config-cwd-tab" class="config-tab-content" style="display: none;">
                <form onsubmit="saveCWDConfig(event)" class="config-form">
                    <div class="form-group">
                        <label for="config-default-cwd">Default Working Directory:</label>
                        <input type="text" id="config-default-cwd" 
                               placeholder="/tmp"
                               value="/tmp">
                        <small class="help-text">The default directory for conversation sessions. You can still override this when starting a conversation.</small>
                    </div>
                    
                    <div class="form-actions">
                        <button type="submit" class="btn-primary">Save CWD Config</button>
                    </div>
                </form>
            </div>
            
            <div class="config-footer">
                <button id="config-continue-btn" class="btn-success" onclick="continueToMain()" style="display: none;">
                    Continue to Main Interface
                </button>
            </div>
        </div>
    </div>
    
    <!-- Settings button on main interface -->
    <button id="settings-btn" class="settings-btn" onclick="openConfigPage()" title="Open Settings">
        ⚙️
    </button>
    
    <script>
        // Global variables
        let currentConversationId = null;
        let eventSource = null;
        let isProcessing = false;
        let eventCounters = {
            total: 0,
            message: 0,
            action: 0,
            observation: 0,
            error: 0
        };
        let events = []; // Store all events for filtering
        let currentImageUrl = null; // Track current displayed image URL
        let cwdWarningShown = false; // Track if CWD warning has been shown
        
        // Server URL configuration
        const isFileProtocol = window.location.protocol === 'file:';
        const serverBaseUrl = isFileProtocol ? 'http://127.0.0.1:8765' : '';
        
        // Helper function to build API URL
        function apiUrl(path) {
            // Remove leading slash if present to avoid double slashes
            const cleanPath = path.startsWith('/') ? path.substring(1) : path;
            return serverBaseUrl ? `${serverBaseUrl}/${cleanPath}` : `/${cleanPath}`;
        }
        
        // Update live image viewer - reuses existing image element for smooth transitions
        function updateLiveImage(imageUrl) {
            const imageViewerContent = document.getElementById('image-viewer-content');
            const noImagePlaceholder = document.getElementById('no-image-placeholder');
            
            // If no image URL provided, clear the viewer
            if (!imageUrl) {
                currentImageUrl = null;
                // Remove any existing image
                const existingImage = imageViewerContent.querySelector('.live-image');
                if (existingImage) {
                    existingImage.remove();
                }
                // Show placeholder
                if (noImagePlaceholder) {
                    noImagePlaceholder.style.display = 'block';
                }
                return;
            }
            
            // Don't update if it's the same image
            if (currentImageUrl === imageUrl) {
                return;
            }
            
            currentImageUrl = imageUrl;
            
            // Hide placeholder
            if (noImagePlaceholder) {
                noImagePlaceholder.style.display = 'none';
            }
            
            // Get existing image or create new one
            let img = imageViewerContent.querySelector('.live-image');
            
            if (!img) {
                // Create new image element
                img = document.createElement('img');
                img.className = 'live-image';
                img.alt = 'Live browser screenshot';
                
                // Add click handler for full-size view
                img.addEventListener('click', function() {
                    toggleImageFullsize({ currentTarget: img });
                });
                
                // Add to viewer
                imageViewerContent.appendChild(img);
            }
            
            // Preserve the fullsize state before updating
            const wasFullsize = img.classList.contains('fullsize');
            
            // Add fade-out effect for smooth transition
            img.classList.add('fade-out');
            
            // Preload the new image before displaying
            const tempImg = new Image();
            tempImg.onload = function() {
                // Update image source
                img.src = imageUrl;
                img.title = 'Click to view full size | ' + new Date().toLocaleTimeString();
                
                // Restore fullsize state if it was zoomed in
                if (wasFullsize) {
                    img.classList.add('fullsize');
                }
                
                // Remove fade effect after a short delay to allow image to render
                setTimeout(function() {
                    img.classList.remove('fade-out');
                }, 50);
                
                console.log(`[Frontend] Updated live image viewer with new screenshot`);
            };
            
            tempImg.onerror = function() {
                img.classList.remove('fade-out');
                console.error(`[Frontend] Failed to load image: ${imageUrl}`);
            };
            
            tempImg.src = imageUrl;
        }
        
        // Initialize on page load
        document.addEventListener('DOMContentLoaded', function() {
            updateCurrentTime();
            setInterval(updateCurrentTime, 1000);
            checkServerStatus();
            
            // Check configuration and load saved settings
            checkConfiguration();
            loadConfigToForm();
            
            // Set up event listeners
            document.getElementById('command-input').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    sendCommand();
                }
            });
            
            // Load saved conversation ID from localStorage
            const savedConvId = localStorage.getItem('openbrowser_conversation_id');
            if (savedConvId) {
                currentConversationId = savedConvId;
                updateConversationIdDisplay();
            }
            
            // Focus on input
            document.getElementById('command-input').focus();
            
            // Initialize image viewer
            updateLiveImage(null);
            
            // Add event listener for cwd input changes
            document.getElementById('cwd-input').addEventListener('change', function() {
                // When cwd changes, clear current conversation to force new creation
                if (currentConversationId) {
                    console.log(`[Frontend] CWD changed to "${this.value}", clearing current conversation`);
                    currentConversationId = null;
                    localStorage.removeItem('openbrowser_conversation_id');
                    updateConversationIdDisplay();
                    
                    // Optional: Show notification
                    addEvent({
                        type: 'SystemEvent',
                        text: `CWD changed to "${this.value}". New conversation will be created on next command.`,
                        timestamp: new Date().toISOString()
                    });
                }
                
                // Reset CWD warning flag when CWD changes
                cwdWarningShown = false;
            });
            
            // Initialize image click handlers
            setupImageClickHandlers();
        });
        
        // Update current time display
        function updateCurrentTime() {
            const now = new Date();
            const timeStr = now.toLocaleTimeString('en-US', { hour12: false });
            document.getElementById('current-time').textContent = timeStr;
        }
        
        // Check server status
        async function checkServerStatus() {
            try {
                const response = await fetch(apiUrl('health'));
                const data = await response.json();
                
                if (data.status === 'healthy') {
                    document.getElementById('server-status').innerHTML = 'SERVER: <span class="status-connected">CONNECTED</span>';
                    document.getElementById('connection-status').textContent = 'Connected';
                    document.getElementById('connection-status').style.color = '#cccccc';
                    
                    if (data.websocket_connected) {
                        document.getElementById('browser-status').innerHTML = 'BROWSER: <span class="status-connected">CONNECTED</span>';
                    } else {
                        document.getElementById('browser-status').innerHTML = 'BROWSER: <span class="status-disconnected">NOT CONNECTED</span>';
                    }
                } else {
                    document.getElementById('server-status').innerHTML = 'SERVER: <span class="status-disconnected">ERROR</span>';
                    document.getElementById('connection-status').textContent = 'Error';
                    document.getElementById('connection-status').style.color = '#888888';
                }
            } catch (error) {
                document.getElementById('server-status').innerHTML = 'SERVER: <span class="status-disconnected">OFFLINE</span>';
                document.getElementById('connection-status').textContent = 'Offline';
                document.getElementById('connection-status').style.color = '#888888';
                document.getElementById('browser-status').innerHTML = 'BROWSER: <span class="status-disconnected">UNKNOWN</span>';
            }
        }
        
        // Send command to agent
        async function sendCommand() {
            const input = document.getElementById('command-input');
            const command = input.value.trim();
            
            if (!command || isProcessing) {
                return;
            }
            
            // Clear input
            input.value = '';
            
            // Add user command to terminal (always show user message)
            console.log(`[Frontend] Sending command: "${command}"`);
            
            // Add user command to terminal (show only the command, time hint will be added by backend)
            addEvent({
                type: 'MessageEvent',
                text: `User: ${command}`,
                timestamp: new Date().toISOString(),
                source: 'user'
            });
            
            // Disable send button
            isProcessing = true;
            document.getElementById('send-button').disabled = true;
            
            // Check if CWD is provided
            const cwdInput = document.getElementById('cwd-input');
            const cwd = cwdInput.value.trim();
            if (!cwd) {
                addEvent({
                    type: 'ErrorEvent',
                    text: 'Please enter a working directory (CWD) before sending commands',
                    timestamp: new Date().toISOString()
                });
                isProcessing = false;
                document.getElementById('send-button').disabled = false;
                return;
            }
            
            // Check if CWD is /tmp and show warning (only once, and only if user hasn't changed from default)
            const normalizedCwd = cwd.trim();
            const isDefaultTmp = normalizedCwd === '/tmp' && cwdInput.value === '/tmp';
            if (isDefaultTmp && !cwdWarningShown) {
                addEvent({
                    type: 'SystemEvent',
                    text: 'SYSTEM WARNING: Using default /tmp directory. Consider setting a specific working directory for better file management.',
                    timestamp: new Date().toISOString()
                });
                cwdWarningShown = true;
            }
            
            // Create or use existing conversation
            let conversationId = currentConversationId;
            if (!conversationId) {
                try {
                    // Get cwd from input field (already validated)
                    
                    const response = await fetch(apiUrl('agent/conversations'), {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ cwd: cwd })
                    });
                    const data = await response.json();
                    conversationId = data.conversation_id;
                    currentConversationId = conversationId;
                    localStorage.setItem('openbrowser_conversation_id', conversationId);
                    updateConversationIdDisplay();
                    
                    // Update cwd display
                    document.getElementById('cwd-input').value = data.cwd || cwd;
                } catch (error) {
                    addEvent({
                        type: 'ErrorEvent',
                        text: `Failed to create conversation: ${error.message}`,
                        timestamp: new Date().toISOString()
                    });
                    isProcessing = false;
                    document.getElementById('send-button').disabled = false;
                    return;
                }
            }
            
            // Close existing EventSource if any
            if (eventSource) {
                eventSource.close();
            }
            
            // Setup SSE connection (cwd already validated)
            setupEventSource(conversationId, command, cwd);
        }
        
        // Setup SSE connection for receiving events
        function setupEventSource(conversationId, command, cwd) {
            const url = apiUrl(`agent/conversations/${conversationId}/messages`);
            console.log(`[Frontend] Setting up EventSource for URL: ${url}, cwd=${cwd}`);
            
            // Using fetch API for SSE streaming (EventSource only works with GET)
            eventSource = null; // No EventSource object, using fetch instead
            
            // Flag to track if error has been handled
            let errorHandled = false;
            // Timeout for SSE completion
            let completionTimeout = null;
            
            // Log SSE connection attempt
            console.log(`[Frontend] Setting up SSE via POST request to: ${url}`);
            
            // Process parsed SSE events
            function processSSEEvent(eventType, eventData) {
                console.log(`[Frontend] Processing SSE event: ${eventType}, data: "${eventData.substring(0, 200)}..."`);
                
                try {
                    if (eventType === 'agent_event') {
                        const data = JSON.parse(eventData);
                        processEvent(data);
                    } else if (eventType === 'complete') {
                        let message = 'Conversation completed';
                        try {
                            const data = JSON.parse(eventData);
                            message = data.message || message;
                        } catch (e) {
                            // Use default message
                        }
                        
                        addEvent({
                            type: 'SystemEvent',
                            text: message,
                            timestamp: new Date().toISOString()
                        });
                        
                        // Clear timeout on completion
                        if (completionTimeout) {
                            clearTimeout(completionTimeout);
                            completionTimeout = null;
                        }
                    } else if (eventType === 'error') {
                        let errorMessage = 'SSE connection error';
                        try {
                            const data = JSON.parse(eventData);
                            errorMessage = data.error || data.message || errorMessage;
                        } catch (e) {
                            // If not JSON, use raw data
                            if (eventData && eventData.trim()) {
                                errorMessage = eventData;
                            }
                        }
                        
                        addEvent({
                            type: 'ErrorEvent',
                            text: `Error: ${errorMessage}`,
                            timestamp: new Date().toISOString()
                        });
                        
                        // Clear timeout on error
                        if (completionTimeout) {
                            clearTimeout(completionTimeout);
                            completionTimeout = null;
                        }
                    } else if (eventType === 'connected') {
                        console.log(`[Frontend] SSE connected: ${eventData}`);
                    } else {
                        console.warn(`[Frontend] Unknown SSE event type: ${eventType}`);
                    }
                } catch (error) {
                    console.error(`[Frontend] Error processing SSE event ${eventType}:`, error, 'data:', eventData);
                    addEvent({
                        type: 'ErrorEvent',
                        text: `Error processing ${eventType} event: ${error.message}`,
                        timestamp: new Date().toISOString()
                    });
                }
            }
            // Send the command and read SSE response
            console.log(`[Frontend] Sending POST request to: ${url} with cwd=${cwd}`);
            
            // Abort controller for cleanup
            const abortController = new AbortController();
            
            fetch(url, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ text: command, cwd: cwd }),
                signal: abortController.signal
            }).then(response => {
                console.log(`[Frontend] POST response status: ${response.status}, ok: ${response.ok}, content-type: ${response.headers.get('content-type')}`);
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }
                
                // Check if response is SSE
                const contentType = response.headers.get('content-type') || '';
                if (!contentType.includes('text/event-stream')) {
                    console.warn(`[Frontend] Response is not SSE (content-type: ${contentType})`);
                    // Try to read as text for debugging
                    return response.text().then(text => {
                        console.log(`[Frontend] Non-SSE response: ${text.substring(0, 200)}...`);
                        throw new Error(`Expected SSE stream but got: ${contentType}`);
                    });
                }
                
                // Setup SSE stream reader
                const reader = response.body.getReader();
                const decoder = new TextDecoder();
                let buffer = '';
                let currentEvent = { type: 'message', data: '' };
                
                function readStream() {
                    return reader.read().then(({ done, value }) => {
                        if (done) {
                            console.log(`[Frontend] SSE stream completed`);
                            // Process any remaining data in buffer
                            if (buffer.trim()) {
                                console.warn(`[Frontend] Unprocessed buffer at stream end: "${buffer}"`);
                            }
                            return;
                        }
                        
                        // Decode and process chunk
                        const chunk = decoder.decode(value, { stream: true });
                        buffer += chunk;
                        
                        // Split into lines and process
                        const lines = buffer.split('\n');
                        buffer = lines.pop() || ''; // Keep incomplete line
                        
                        for (let line of lines) {
                            line = line.trim();
                            
                            // Skip empty lines and comments
                            if (line === '' || line.startsWith(':')) {
                                // Empty line indicates end of event
                                if (line === '' && currentEvent.data) {
                                    processSSEEvent(currentEvent.type, currentEvent.data);
                                    currentEvent = { type: 'message', data: '' };
                                }
                                continue;
                            }
                            
                            // Parse SSE field
                            const colonIndex = line.indexOf(':');
                            if (colonIndex === -1) {
                                console.warn(`[Frontend] Invalid SSE line (no colon): "${line}"`);
                                continue;
                            }
                            
                            const field = line.substring(0, colonIndex).trim();
                            let value = line.substring(colonIndex + 1).trim();
                            
                            // Handle leading space (SSE spec)
                            if (value.startsWith(' ')) {
                                value = value.substring(1);
                            }
                            
                            // Process field
                            if (field === 'event') {
                                currentEvent.type = value;
                            } else if (field === 'data') {
                                currentEvent.data = currentEvent.data ? currentEvent.data + '\n' + value : value;
                            } else if (field === 'id' || field === 'retry') {
                                // Ignore for now
                            } else {
                                console.warn(`[Frontend] Unknown SSE field: ${field}`);
                            }
                        }
                        
                        // Continue reading
                        return readStream();
                    });
                }
                
                // Start reading the stream
                return readStream();
            }).catch(error => {
                // Skip abort errors (expected during cleanup)
                if (error.name === 'AbortError') {
                    console.log('[Frontend] Request aborted (expected during cleanup)');
                    return;
                }
                
                console.error('[Frontend] Fetch/SSE error:', error);
                addEvent({
                    type: 'ErrorEvent',
                    text: `Failed to process command: ${error.message}`,
                    timestamp: new Date().toISOString()
                });
            }).finally(() => {
                // Cleanup
                isProcessing = false;
                document.getElementById('send-button').disabled = false;
                if (completionTimeout) {
                    clearTimeout(completionTimeout);
                    completionTimeout = null;
                }
                abortController.abort();
            });
            

            
            eventSource.addEventListener('complete', function(event) {
                try {
                    if (event.data && typeof event.data === 'string' && event.data.trim() !== '') {
                        const data = JSON.parse(event.data);
                        addEvent({
                            type: 'SystemEvent',
                            text: `Conversation completed: ${data.message || 'Done'}`,
                            timestamp: new Date().toISOString()
                        });
                    } else {
                        addEvent({
                            type: 'SystemEvent',
                            text: 'Conversation completed',
                            timestamp: new Date().toISOString()
                        });
                    }
                    
                    // Clear completion timeout
                    if (completionTimeout) {
                        clearTimeout(completionTimeout);
                        completionTimeout = null;
                    }
                    
                    // Re-enable send button
                    isProcessing = false;
                    document.getElementById('send-button').disabled = false;
                    
                    // Close EventSource
                    if (eventSource) {
                        eventSource.close();
                        eventSource = null;
                    }
                } catch (error) {
                    console.error('Error parsing complete event:', error, 'data:', event.data);
                    addEvent({
                        type: 'SystemEvent',
                        text: 'Conversation completed with error',
                        timestamp: new Date().toISOString()
                    });
                    isProcessing = false;
                    document.getElementById('send-button').disabled = false;
                }
            });
            
            eventSource.addEventListener('error', function(event) {
                try {
                    // Mark error as handled
                    errorHandled = true;
                    
                    
                    // Clear completion timeout
                    if (completionTimeout) {
                        clearTimeout(completionTimeout);
                        completionTimeout = null;
                    }
                    // Check if event.data exists and is a non-empty string (not undefined/null)
                    if (event.data && typeof event.data === 'string' && event.data.trim() !== '') {
                        // Try to parse as JSON if it doesn't look like a simple string
                        if (event.data.trim().startsWith('{') && event.data.trim().endsWith('}')) {
                            const data = JSON.parse(event.data);
                            addEvent({
                                type: 'ErrorEvent',
                                text: `Error: ${data.error || data.message || 'Unknown error'}`,
                                timestamp: new Date().toISOString()
                            });
                        } else {
                            // If it's a string but not JSON, show it as-is
                            addEvent({
                                type: 'ErrorEvent',
                                text: `Error: ${event.data}`,
                                timestamp: new Date().toISOString()
                            });
                        }
                    } else {
                        // Generic SSE error when event.data is undefined, null, or empty
                        addEvent({
                            type: 'ErrorEvent',
                            text: 'SSE connection error',
                            timestamp: new Date().toISOString()
                        });
                    }
                    
                    // Re-enable send button
                    isProcessing = false;
                    document.getElementById('send-button').disabled = false;
                    
                    // Close EventSource
                    if (eventSource) {
                        eventSource.close();
                        eventSource = null;
                    }
                } catch (error) {
                    console.error('Error parsing error event:', error);
                    addEvent({
                        type: 'ErrorEvent',
                        text: `SSE Error: ${error.message}`,
                        timestamp: new Date().toISOString()
                    });
                }
            });
            
            // Set completion timeout (300 seconds / 5 minutes)
            completionTimeout = setTimeout(() => {
                console.warn('[Frontend] SSE completion timeout - no complete event received after 300 seconds');
                if (!errorHandled) {
                    errorHandled = true;
                    addEvent({
                        type: 'SystemEvent',
                        text: 'SSE timeout - connection may have hung',
                        timestamp: new Date().toISOString()
                    });
                    isProcessing = false;
                    document.getElementById('send-button').disabled = false;
                    // Note: Cannot abort fetch from here as abortController is in fetch scope
                    // The fetch will eventually complete or error on its own
                }
            }, 300000);
            

            

        }
        
        // Process incoming event
        function processEvent(data) {
            // Apply filtering rules
            const eventType = data.type;
            console.log(`[Frontend] Processing event type: "${eventType}", data:`, data);
            
            // Skip SystemPromptEvent entirely (not shown at all)
            if (eventType === 'SystemPromptEvent') {
                console.log(`[Frontend] Skipping SystemPromptEvent`);
                return;
            }
            
            // Skip MessageEvent with role 'user' (we already show user input separately)
            if (eventType === 'MessageEvent' && data.role === 'user') {
                console.log(`[Frontend] Skipping user MessageEvent from SSE (already shown)`);
                return;
            }
            
            // Determine source based on role or event type
            let source = 'agent'; // default
            if (eventType === 'MessageEvent') {
                // Use role field for MessageEvent
                source = data.role === 'user' ? 'user' : 'agent';
            } else if (data.text && data.text.includes('user:')) {
                // Fallback for other event types that might have user text
                source = 'user';
            }
            
            // Create event object
            const event = {
                id: `event-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`,
                type: eventType,
                text: data.text || '',
                timestamp: data.timestamp || new Date().toISOString(),
                image: data.image || null,
                success: data.success,
                message: data.message,
                error: data.error,
                role: data.role || null, // Include role field
                activated_skills: data.activated_skills || null,
                sender: data.sender || null,
                source: source,
                summary: data.summary || null // Include summary field for collapsed display
            };
            
            console.log(`[Frontend] Created event:`, event);
            
            // Update live image viewer if event has an image
            if (event.image) {
                updateLiveImage(event.image);
            }
            
            // Add to events array
            events.push(event);
            
            // Update counters
            updateEventCounters(eventType);
            
            // Render event (without image in the event line)
            addEvent(event);
        }
        
        // Update event counters and display
        function updateEventCounters(eventType) {
            eventCounters.total++;
            
            switch (eventType) {
                case 'MessageEvent':
                    eventCounters.message++;
                    break;
                case 'ActionEvent':
                    eventCounters.action++;
                    break;
                case 'ObservationEvent':
                    eventCounters.observation++;
                    break;
                case 'ErrorEvent':
                    eventCounters.error++;
                    break;
            }
            
            // Update display
            document.getElementById('event-count').innerHTML = `EVENTS: <span>${escapeHtml(eventCounters.total)}</span>`;
            document.getElementById('stat-total').textContent = eventCounters.total;
            document.getElementById('stat-message').textContent = eventCounters.message;
            document.getElementById('stat-action').textContent = eventCounters.action;
            document.getElementById('stat-observation').textContent = eventCounters.observation;
            document.getElementById('stat-error').textContent = eventCounters.error;
        }
        
        // Add event to terminal display
        function addEvent(event) {
            console.log(`[Frontend] addEvent called with:`, event);
            const terminalOutput = document.getElementById('terminal-output');
            
            // Create event line
            const eventLine = document.createElement('div');
            eventLine.className = 'event-line collapsed';
            eventLine.id = event.id;
            eventLine.dataset.type = event.type;
            eventLine.dataset.source = event.source || 'system';
            console.log(`[Frontend] Created eventLine with dataset.type: "${eventLine.dataset.type}", dataset.source: "${eventLine.dataset.source}"`);
            
            // Determine event type color
            let typeColor = '#666666'; // Default system color
            if (event.type === 'MessageEvent') {
                typeColor = event.source === 'user' ? '#aaaaaa' : '#cccccc';
            } else if (event.type === 'ActionEvent') {
                typeColor = '#aaaaaa';
            } else if (event.type === 'ObservationEvent') {
                typeColor = '#aaaaaa';
            } else if (event.type === 'ErrorEvent') {
                typeColor = '#888888';
            }
            
            // Format timestamp
            const timestamp = new Date(event.timestamp);
            const timeStr = timestamp.toLocaleTimeString('en-US', { hour12: false });
            
            // Build content
            let content = event.text || event.message || '';
            if (event.error) {
                content = `ERROR: ${event.error}`;
            }
            
            // Add metadata for MessageEvent
            let metadataHtml = '';
            if (event.type === 'MessageEvent') {
                if (event.role) {
                    metadataHtml += `<div class="event-meta"><small>Role: ${escapeHtml(event.role)}</small></div>`;
                }
                if (event.activated_skills && event.activated_skills.length > 0) {
                    metadataHtml += `<div class="event-meta"><small>Skills: ${escapeHtml(event.activated_skills.join(', '))}</small></div>`;
                }
                if (event.sender) {
                    metadataHtml += `<div class="event-meta"><small>Sender: ${escapeHtml(event.sender)}</small></div>`;
                }
            }
            
            // Create HTML
            eventLine.innerHTML = `
                <div class="event-header">
                    <span class="event-type" style="color: ${typeColor}">${event.type.replace('Event', '').toUpperCase()}</span>
                    ${event.summary ? `<span class="event-header-summary">: ${escapeHtml(event.summary)}</span>` : ''}
                    <span class="event-timestamp">${timeStr}</span>
                    <span class="expand-toggle" onclick="toggleEvent(this)">[expand]</span>
                </div>
                <div class="event-content">
                    ${metadataHtml}
                    <div class="event-full-content">
                        ${formatContent(content)}
                    </div>
                </div>
            `;
            
            // Apply filter visibility
            updateEventVisibility(eventLine);
            
            // Add to terminal
            terminalOutput.appendChild(eventLine);
            
            // Auto-expand if setting is enabled
            const autoExpand = document.getElementById('auto-expand').checked;
            if (autoExpand) {
                expandEvent(eventLine);
            }
            
            // Scroll to bottom
            terminalOutput.scrollTop = terminalOutput.scrollHeight;
            
            return eventLine;
        }
        
        // Escape HTML special characters
        function escapeHtml(text) {
            if (text === null || text === undefined) return '';
            const div = document.createElement('div');
            div.textContent = String(text);
            return div.innerHTML;
        }
        
        // Format content for display
        function formatContent(content) {
            if (content === null || content === undefined) return '';
            
            // First escape HTML to prevent XSS
            content = escapeHtml(content);
            
            // Convert line breaks
            content = content.replace(/\n/g, '<br>');
            
            // Add prompt style to lines that start with certain patterns
            // Note: '>' is escaped as '&gt;', '$' and '#' don't need escaping
            content = content.replace(/^(\s*)(&gt;|\$|#)/gm, '$1<span class="prompt-line">$2</span>');
            
            return content;
        }
        
        // Toggle event expansion
        function toggleEvent(toggleElement) {
            const eventLine = toggleElement.closest('.event-line');
            if (eventLine.classList.contains('collapsed')) {
                expandEvent(eventLine);
            } else {
                collapseEvent(eventLine);
            }
        }
        
        // Expand event
        function expandEvent(eventLine) {
            eventLine.classList.remove('collapsed');
            eventLine.classList.add('expanded');
            const toggle = eventLine.querySelector('.expand-toggle');
            if (toggle) {
                toggle.textContent = '[collapse]';
            }
        }
        
        // Collapse event
        function collapseEvent(eventLine) {
            eventLine.classList.remove('expanded');
            eventLine.classList.add('collapsed');
            const toggle = eventLine.querySelector('.expand-toggle');
            if (toggle) {
                toggle.textContent = '[expand]';
            }
        }
        
        // Update event visibility based on filter settings
        function updateEventVisibility(eventLine = null) {
            const showSystem = document.getElementById('filter-system').checked;
            const showUserMessages = document.getElementById('filter-user-message').checked;
            
            if (eventLine) {
                // Update single event
                const eventType = eventLine.dataset.type;
                const eventSource = eventLine.dataset.source;
                
                let shouldShow = true;
                
                if (eventType && eventType.includes('System')) {
                    shouldShow = showSystem;
                } else if (eventType === 'MessageEvent' && eventSource === 'user') {
                    shouldShow = showUserMessages;
                }
                
                eventLine.classList.toggle('hidden', !shouldShow);
            } else {
                // Update all events
                document.querySelectorAll('.event-line').forEach(line => {
                    const eventType = line.dataset.type;
                    const eventSource = line.dataset.source;
                    
                    let shouldShow = true;
                    
                    if (eventType && eventType.includes('System')) {
                        shouldShow = showSystem;
                    } else if (eventType === 'MessageEvent' && eventSource === 'user') {
                        shouldShow = showUserMessages;
                    }
                    
                    line.classList.toggle('hidden', !shouldShow);
                });
            }
        }
        
        // Set command in input field
        function setCommand(command) {
            document.getElementById('command-input').value = command;
            document.getElementById('command-input').focus();
        }
        
        // Clear terminal
        function clearTerminal() {
            const terminalOutput = document.getElementById('terminal-output');
            
            // Keep only the first system message
            const allEvents = terminalOutput.querySelectorAll('.event-line');
            for (let i = 1; i < allEvents.length; i++) {
                allEvents[i].remove();
            }
            
            // Clear events array and counters
            events = [];
            resetEventCounters();
            
            // Clear image viewer
            updateLiveImage(null);
            
            // Add clear message
            addEvent({
                type: 'SystemEvent',
                text: 'Terminal cleared.',
                timestamp: new Date().toISOString()
            });
        }
        
        // Reset event counters
        function resetEventCounters() {
            eventCounters = {
                total: 0,
                message: 0,
                action: 0,
                observation: 0,
                error: 0
            };
            
            // Update display
            document.getElementById('event-count').innerHTML = 'EVENTS: <span>0</span>';
            document.getElementById('stat-total').textContent = '0';
            document.getElementById('stat-message').textContent = '0';
            document.getElementById('stat-action').textContent = '0';
            document.getElementById('stat-observation').textContent = '0';
            document.getElementById('stat-error').textContent = '0';
        }
        
        // Update conversation ID display
        function updateConversationIdDisplay() {
            const display = document.getElementById('conversation-id');
            if (currentConversationId) {
                display.textContent = currentConversationId;
                display.title = currentConversationId;
            } else {
                display.textContent = 'None';
                display.title = '';
            }
        }
        
        // Refresh conversation ID from server
        async function refreshConversationId() {
            // Clear current conversation ID to force creation of a new one on next command
            const oldConversationId = currentConversationId;
            currentConversationId = null;
            localStorage.removeItem('openbrowser_conversation_id');
            updateConversationIdDisplay();
            
            if (oldConversationId) {
                addEvent({
                    type: 'SystemEvent',
                    text: `Cleared conversation ID: ${oldConversationId}. A new UUID will be generated on next command.`,
                    timestamp: new Date().toISOString()
                });
            } else {
                addEvent({
                    type: 'SystemEvent',
                    text: 'No active conversation. A new UUID will be generated on next command.',
                    timestamp: new Date().toISOString()
                });
            }
        }
        
        // Image handling functions
        function setupImageClickHandlers() {
            // Add click handlers to all event images
            document.querySelectorAll('.event-image').forEach(img => {
                if (!img.hasAttribute('data-click-handler')) {
                    img.setAttribute('data-click-handler', 'true');
                    img.addEventListener('click', toggleImageFullsize);
                }
            });
        }
        
        function toggleImageFullsize(event) {
            const img = event.currentTarget;
            const overlay = document.getElementById('image-overlay') || createImageOverlay();
            
            if (img.classList.contains('fullsize')) {
                // Restore to normal size
                img.classList.remove('fullsize');
                overlay.style.display = 'none';
                document.removeEventListener('keydown', handleEscapeKey);
            } else {
                // Show fullsize
                img.classList.add('fullsize');
                overlay.style.display = 'block';
                document.addEventListener('keydown', handleEscapeKey);
                
                // Click overlay to close
                overlay.onclick = function(e) {
                    if (e.target === overlay) {
                        img.classList.remove('fullsize');
                        overlay.style.display = 'none';
                        document.removeEventListener('keydown', handleEscapeKey);
                    }
                };
            }
        }
        
        function createImageOverlay() {
            const overlay = document.createElement('div');
            overlay.id = 'image-overlay';
            overlay.className = 'image-overlay';
            document.body.appendChild(overlay);
            return overlay;
        }
        
        function handleEscapeKey(event) {
            if (event.key === 'Escape') {
                // Look for both event-image and live-image classes
                const fullsizeImg = document.querySelector('.event-image.fullsize, .live-image.fullsize');
                if (fullsizeImg) {
                    fullsizeImg.classList.remove('fullsize');
                    const overlay = document.getElementById('image-overlay');
                    if (overlay) overlay.style.display = 'none';
                    document.removeEventListener('keydown', handleEscapeKey);
                }
            }
        }
        
        // Update image handlers after adding new events
        function updateImageHandlers() {
            setTimeout(setupImageClickHandlers, 100);
        }
        
        // --- Configuration Management ---
        
        let appConfig = null;
        
        // Check if application is configured on page load
        async function checkConfiguration() {
            try {
                const response = await fetch(apiUrl('/api/config'));
                if (!response.ok) {
                    throw new Error('Failed to fetch configuration');
                }
                const data = await response.json();
                appConfig = data.config;
                
                if (!appConfig.is_configured) {
                    showConfigPage();
                } else {
                    hideConfigPage();
                    // Set default CWD in the input field
                    document.getElementById('cwd-input').value = appConfig.default_cwd || '/tmp';
                }
            } catch (error) {
                console.error('Error checking configuration:', error);
                showConfigPage();
            }
        }
        
        // Show configuration page
        function showConfigPage() {
            const configPage = document.getElementById('config-page');
            const mainInterface = document.getElementById('main-interface');
            if (configPage) configPage.style.display = 'flex';
            if (mainInterface) mainInterface.style.display = 'none';
        }
        
        // Hide configuration page
        function hideConfigPage() {
            const configPage = document.getElementById('config-page');
            const mainInterface = document.getElementById('main-interface');
            if (configPage) configPage.style.display = 'none';
            // Use flex with column direction to match CSS
            if (mainInterface) {
                mainInterface.style.display = 'flex';
                mainInterface.style.flexDirection = 'column';
            }
        }
        
        // Load configuration into form
        async function loadConfigToForm() {
            try {
                const response = await fetch(apiUrl('/api/config'));
                if (!response.ok) {
                    throw new Error('Failed to fetch configuration');
                }
                const data = await response.json();
                appConfig = data.config;
                
                // Populate LLM config form
                document.getElementById('config-model').value = appConfig.llm.model || 'dashscope/qwen3.5-plus';
                document.getElementById('config-base-url').value = appConfig.llm.base_url || 'https://dashscope.aliyuncs.com/compatible-mode/v1';
                document.getElementById('config-api-key').value = appConfig.llm.api_key || '';
                document.getElementById('config-api-key').placeholder = appConfig.llm.has_api_key ? 'API key configured (hidden)' : 'Enter your API key';
                
                // Populate CWD config form
                document.getElementById('config-default-cwd').value = appConfig.default_cwd || '/tmp';
            } catch (error) {
                console.error('Error loading configuration:', error);
                addEvent({
                    type: 'SystemEvent',
                    text: `Error loading configuration: ${error.message}`,
                    timestamp: new Date().toISOString()
                });
            }
        }
        
        // Save LLM configuration
        async function saveLLMConfig(event) {
            event.preventDefault();
            
            const model = document.getElementById('config-model').value || 'dashscope/qwen3.5-plus';
            const baseUrl = document.getElementById('config-base-url').value || 'https://dashscope.aliyuncs.com/compatible-mode/v1';
            const apiKey = document.getElementById('config-api-key').value;
            
            if (!apiKey && !appConfig?.llm?.has_api_key) {
                alert('API key is required');
                return;
            }
            
            try {
                const response = await fetch(apiUrl('/api/config/llm'), {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        model: model,
                        base_url: baseUrl,
                        api_key: apiKey || '********'  // Send masked value to keep existing
                    })
                });
                
                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.detail || 'Failed to save LLM configuration');
                }
                
                const data = await response.json();
                console.log('LLM configuration saved:', data);
                
                // Update appConfig
                if (!appConfig) appConfig = { llm: {}, default_cwd: '/tmp' };
                appConfig.llm.model = data.config.model;
                appConfig.llm.base_url = data.config.base_url;
                appConfig.llm.has_api_key = data.config.has_api_key;
                
                alert('LLM configuration saved successfully!');
                
                // Check if fully configured
                if (appConfig.is_configured !== undefined) {
                    appConfig.is_configured = appConfig.llm.has_api_key;
                }
                
                // If configured, allow to continue
                if (appConfig.llm.has_api_key) {
                    document.getElementById('config-continue-btn').style.display = 'inline-block';
                }
            } catch (error) {
                console.error('Error saving LLM configuration:', error);
                alert(`Error saving configuration: ${error.message}`);
            }
        }
        
        // Save default CWD
        async function saveCWDConfig(event) {
            event.preventDefault();
            
            const cwd = document.getElementById('config-default-cwd').value;
            
            if (!cwd) {
                alert('Default CWD is required');
                return;
            }
            
            try {
                const response = await fetch(apiUrl('/api/config/cwd'), {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        cwd: cwd
                    })
                });
                
                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.detail || 'Failed to save CWD configuration');
                }
                
                const data = await response.json();
                console.log('CWD configuration saved:', data);
                
                // Update appConfig
                if (!appConfig) appConfig = { llm: {}, default_cwd: '/tmp' };
                appConfig.default_cwd = data.default_cwd;
                
                // Update main interface CWD input
                document.getElementById('cwd-input').value = data.default_cwd;
                
                alert('Default working directory saved successfully!');
            } catch (error) {
                console.error('Error saving CWD configuration:', error);
                alert(`Error saving configuration: ${error.message}`);
            }
        }
        
        // Continue to main interface
        function continueToMain() {
            if (appConfig && appConfig.llm && appConfig.llm.has_api_key) {
                hideConfigPage();
                // Reload configuration to ensure CWD is updated
                checkConfiguration();
            } else {
                alert('Please configure your API key first');
            }
        }
        
        // Show config page from main interface
        function openConfigPage() {
            loadConfigToForm();
            showConfigPage();
        }
        
        // Switch configuration tabs
        function switchConfigTab(tabName) {
            // Update tab buttons
            document.querySelectorAll('.config-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            event.target.classList.add('active');
            
            // Update tab content
            document.querySelectorAll('.config-tab-content').forEach(content => {
                content.style.display = 'none';
                content.classList.remove('active');
            });
            
            const targetTab = document.getElementById(`config-${tabName}-tab`);
            if (targetTab) {
                targetTab.style.display = 'block';
                targetTab.classList.add('active');
            }
        }
    </script>
</body>
</html>