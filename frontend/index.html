<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OpenBrowserAgent - Terminal Interface</title>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Monaco', 'Menlo', 'Consolas', 'Courier New', monospace;
            background-color: #1a1a1a;
            color: #cccccc;
            line-height: 1.4;
            min-height: 100vh;
            padding: 0;
            overflow-x: hidden;
        }

        .terminal-header {
            background: #222222;
            border-bottom: 1px solid #444444;
            padding: 10px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
        }

        .ascii-title {
            font-family: monospace;
            white-space: pre;
            font-size: 12px;
            line-height: 1.2;
            color: #ffffff;
            margin: 0;
            letter-spacing: 0.5px;
        }

        .status-bar {
            display: flex;
            gap: 15px;
            font-size: 12px;
        }

        .status-item {
            padding: 4px 8px;
            background: #222222;
            border-radius: 3px;
            border: 1px solid #444444;
        }

        .status-connected {
            color: #cccccc;
        }

        .status-disconnected {
            color: #888888;
        }

        .container {
            display: flex;
            height: calc(100vh - 60px);
        }

        .main-terminal {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: #1a1a1a;
            border-right: 1px solid #444444;
        }

        .terminal-output {
            flex: 1;
            overflow-y: auto;
            padding: 20px 20px 80px 20px;
            font-family: 'Monaco', 'Menlo', 'Consolas', monospace;
            font-size: 13px;
            line-height: 1.5;
        }

        .event-line {
            margin-bottom: 8px;
            padding: 5px 10px;
            border-left: 2px solid #444444;
            transition: all 0.2s;
            cursor: pointer;
            position: relative;
        }

        .event-line:hover {
            background: #222222;
            border-left-color: #666666;
        }

        .event-line.collapsed {
            max-height: 24px;
            overflow: hidden;
        }

        .event-line.expanded {
            background: #222222;
            border-left-color: #666666;
        }

        .event-header {
            display: flex;
            align-items: center;
            margin-bottom: 5px;
        }

        .event-type {
            font-weight: bold;
            color: #aaaaaa;
            margin-right: 10px;
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .event-timestamp {
            color: #666666;
            font-size: 10px;
            margin-right: 10px;
        }

        .expand-toggle {
            color: #666666;
            font-size: 10px;
            margin-left: auto;
            cursor: pointer;
            user-select: none;
        }

        .expand-toggle:hover {
            color: #aaaaaa;
        }

        .event-content {
            white-space: pre-wrap;
            font-family: 'Monaco', 'Menlo', 'Consolas', monospace;
            font-size: 12px;
            color: #cccccc;
            line-height: 1.4;
        }

        .event-image {
            margin-top: 10px;
            max-width: 100%;
            border: 1px solid #444444;
            border-radius: 3px;
        }

        .prompt-line {
            color: #cccccc;
        }

        .prompt-line::before {
            content: "> ";
            color: #cccccc;
        }

        .input-area {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 300px;
            border-top: 1px solid #444444;
            padding: 15px 20px;
            background: #222222;
            display: flex;
            align-items: center;
            z-index: 100;
        }

        .input-prompt {
            color: #cccccc;
            margin-right: 10px;
            user-select: none;
        }

        .command-input {
            flex: 1;
            background: transparent;
            border: none;
            color: #cccccc;
            font-family: 'Monaco', 'Menlo', 'Consolas', monospace;
            font-size: 13px;
            outline: none;
            caret-color: #cccccc;
        }

        .command-input::placeholder {
            color: #666666;
        }

        .send-button {
            background: #222222;
            color: #cccccc;
            border: 1px solid #444444;
            padding: 6px 15px;
            font-family: 'Monaco', 'Menlo', 'Consolas', monospace;
            font-size: 12px;
            cursor: pointer;
            margin-left: 10px;
            transition: all 0.2s;
        }

        .send-button:hover:not(:disabled) {
            background: #444444;
            color: #ffffff;
            border-color: #444444;
        }

        .send-button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .sidebar {
            width: 300px;
            background: #222222;
            padding: 20px;
            border-left: 1px solid #444444;
            overflow-y: auto;
        }

        .sidebar-section {
            margin-bottom: 25px;
        }

        .sidebar-title {
            color: #cccccc;
            font-size: 14px;
            margin-bottom: 10px;
            padding-bottom: 5px;
            border-bottom: 1px solid #444444;
        }

        .connection-info {
            background: #222222;
            padding: 10px;
            border-radius: 3px;
            border: 1px solid #444444;
            margin-bottom: 15px;
        }

        .info-line {
            margin-bottom: 5px;
            font-size: 11px;
        }

        .info-label {
            color: #666666;
            display: inline-block;
            width: 80px;
        }

        .info-value {
            color: #cccccc;
        }

        .event-stats {
            background: #222222;
            padding: 10px;
            border-radius: 3px;
            border: 1px solid #444444;
        }

        .stat-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
            font-size: 11px;
        }

        .stat-label {
            color: #666666;
        }

        .stat-value {
            color: #cccccc;
        }

        .scrollbar {
            scrollbar-width: thin;
            scrollbar-color: #444444 #222222;
        }

        .scrollbar::-webkit-scrollbar {
            width: 8px;
        }

        .scrollbar::-webkit-scrollbar-track {
            background: #222222;
        }

        .scrollbar::-webkit-scrollbar-thumb {
            background: #444444;
            border-radius: 4px;
        }

        .scrollbar::-webkit-scrollbar-thumb:hover {
            background: #555555;
        }

        .blink {
            animation: blink 1s infinite;
        }

        @keyframes blink {
            0%, 100% { opacity: 1; }
            50% { opacity: 0; }
        }

        .hidden {
            display: none !important;
        }

        .loading-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border: 2px solid #444444;
            border-top-color: #cccccc;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 8px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="terminal-header">
        <div class="ascii-title">
    ,----..   ,-.----.                      ,--.                         ,----..                                                     
   /   /   \  \    /  \      ,---,.       ,--.'|    ,---,. ,-.----.     /   /   \             .---.  .--.--.       ,---,.,-.----.    
  /   .     : |   :    \   ,'  .' |   ,--,:  : |  ,'  .'  \\    /  \   /   .     :           /. ./| /  /    '.   ,'  .' |\    /  \   
 .   /   ;.  \|   |  .\ :,---.'   |,`--.'`|  ' :,---.' .' |;   :    \ .   /   ;.  \      .--'.  ' ;|  :  /`. / ,---.'   |;   :    \  
.   ;   /  ` ;.   :  |: ||   |   .'|   :  :  | ||   |  |: ||   | .\ :.   ;   /  ` ;     /__./ \ : |;  |  |--`  |   |   .'|   | .\ :  
;   |  ; \ ; ||   |   \ ::   :  |-,:   |   \ | ::   :  :  /.   : |: |;   |  ; \ ; | .--'.  '   \' .|  :  ;_    :   :  |-,.   : |: |  
|   :  | ; | '|   : .   /:   |  ;/||   : '  '; |:   |    ; |   |  \ :|   :  | ; | '/___/ \ |    ' ' \  \    `. :   |  ;/||   |  \ :  
.   |  ' ' ' :;   | |`-' |   :   .''   ' ;.    ;|   :     \|   : .  /.   |  ' ' ' :;   \  \;      :  `----.   \|   :   .'|   : .  /  
'   ;  \; /  ||   | ;    |   |  |-,|   | | \   ||   |   . |;   | |  \'   ;  \; /  | \   ;  `      |  __ \  \  ||   |  |-,;   | |  \  
 \   \  ',  / :   ' |    '   :  ;/|'   : |  ; .''   :  '; ||   | ;\  \\   \  ',  /   .   \    .\  ; /  /`--'  /'   :  ;/||   | ;\  \ 
  ;   :    /  :   : :    |   |    \|   | '`--'  |   |  | ; :   ' | \.' ;   :    /     \   \   ' \ |'--'.     / |   |    \:   ' | \.' 
   \   \ .'   |   | :    |   :   .''   : |      |   :   /  :   : :-'    \   \ .'       :   '  |--"   `--'---'  |   :   .':   : :-'   
    `---`     `---'.|    |   | ,'  ;   |.'      |   | ,'   |   |.'       `---`          \   \ ;                |   | ,'  |   |.'     
                `---`    `----'    '---'        `----'     `---'                         '---"                 `----'    `---'       
        </div>
        <div class="status-bar">
            <div class="status-item" id="server-status">SERVER: <span class="status-disconnected">DISCONNECTED</span></div>
            <div class="status-item" id="browser-status">BROWSER: <span class="status-disconnected">NOT CONNECTED</span></div>
            <div class="status-item" id="event-count">EVENTS: <span>0</span></div>
        </div>
    </div>
    
    <div class="container">
        <div class="main-terminal">
            <div class="terminal-output scrollbar" id="terminal-output">
                <!-- Event lines will be dynamically added here -->
                <div class="event-line expanded">
                    <div class="event-header">
                        <span class="event-type" style="color: #666666;">SYSTEM</span>
                        <span class="event-timestamp" id="current-time"></span>
                        <span class="expand-toggle" onclick="toggleEvent(this)">[collapse]</span>
                    </div>
                    <div class="event-content">
                        <div class="prompt-line">OpenBrowserAgent Terminal Interface v1.0</div>
                        <div class="prompt-line">Type commands below to control the browser via AI</div>
                        <div class="prompt-line">System ready. Waiting for input...</div>
                    </div>
                </div>
            </div>
            
            <div class="input-area">
                <div class="input-prompt blink">></div>
                <input type="text" class="command-input" id="command-input" placeholder="Type a command (e.g., 'open google.com') and press Enter" autofocus>
                <button class="send-button" id="send-button" onclick="sendCommand()">SEND</button>
            </div>
        </div>
        
        <div class="sidebar scrollbar">
            <div class="sidebar-section">
                <div class="sidebar-title">CONNECTION INFO</div>
                <div class="connection-info">
                    <div class="info-line">
                        <span class="info-label">Server:</span>
                        <span class="info-value" id="server-url">http://127.0.0.1:8765</span>
                    </div>
                    <div class="info-line">
                        <span class="info-label">Status:</span>
                        <span class="info-value" id="connection-status">Not connected</span>
                    </div>
                    <div class="info-line">
                        <span class="info-label">Conversation:</span>
                        <span class="info-value" id="conversation-id">None</span>
                    </div>
                </div>
            </div>
            
            <div class="sidebar-section">
                <div class="sidebar-title">EVENT STATISTICS</div>
                <div class="event-stats">
                    <div class="stat-item">
                        <span class="stat-label">Total Events:</span>
                        <span class="stat-value" id="stat-total">0</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">Message Events:</span>
                        <span class="stat-value" id="stat-message">0</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">Action Events:</span>
                        <span class="stat-value" id="stat-action">0</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">Observation Events:</span>
                        <span class="stat-value" id="stat-observation">0</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">Errors:</span>
                        <span class="stat-value" id="stat-error">0</span>
                    </div>
                </div>
            </div>
            
            <div class="sidebar-section">
                <div class="sidebar-title">FILTER SETTINGS</div>
                <div class="event-stats">
                    <div class="stat-item">
                        <span class="stat-label">Show System Events:</span>
                        <span class="stat-value">
                            <input type="checkbox" id="filter-system" checked onchange="updateEventVisibility()">
                        </span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">Show User Messages:</span>
                        <span class="stat-value">
                            <input type="checkbox" id="filter-user-message" onchange="updateEventVisibility()">
                        </span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">Auto-expand Events:</span>
                        <span class="stat-value">
                            <input type="checkbox" id="auto-expand" checked>
                        </span>
                    </div>
                </div>
            </div>
            
            <div class="sidebar-section">
                <div class="sidebar-title">QUICK COMMANDS</div>
                <div class="event-stats">
                    <div class="stat-item">
                        <button class="send-button" style="width: 100%; margin: 5px 0; font-size: 11px;" onclick="setCommand('open google.com')">open google.com</button>
                    </div>
                    <div class="stat-item">
                        <button class="send-button" style="width: 100%; margin: 5px 0; font-size: 11px;" onclick="setCommand('tabs list')">tabs list</button>
                    </div>
                    <div class="stat-item">
                        <button class="send-button" style="width: 100%; margin: 5px 0; font-size: 11px;" onclick="setCommand('mouse reset')">mouse reset</button>
                    </div>
                    <div class="stat-item">
                        <button class="send-button" style="width: 100%; margin: 5px 0; font-size: 11px;" onclick="clearTerminal()">CLEAR TERMINAL</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        // Global variables
        let currentConversationId = null;
        let eventSource = null;
        let isProcessing = false;
        let eventCounters = {
            total: 0,
            message: 0,
            action: 0,
            observation: 0,
            error: 0
        };
        let events = []; // Store all events for filtering
        
        // Server URL configuration
        const isFileProtocol = window.location.protocol === 'file:';
        const serverBaseUrl = isFileProtocol ? 'http://127.0.0.1:8765' : '';
        
        // Helper function to build API URL
        function apiUrl(path) {
            // Remove leading slash if present to avoid double slashes
            const cleanPath = path.startsWith('/') ? path.substring(1) : path;
            return serverBaseUrl ? `${serverBaseUrl}/${cleanPath}` : `/${cleanPath}`;
        }
        
        // Initialize on page load
        document.addEventListener('DOMContentLoaded', function() {
            updateCurrentTime();
            setInterval(updateCurrentTime, 1000);
            checkServerStatus();
            
            // Set up event listeners
            document.getElementById('command-input').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    sendCommand();
                }
            });
            
            // Load saved conversation ID from localStorage
            const savedConvId = localStorage.getItem('openbrowser_conversation_id');
            if (savedConvId) {
                currentConversationId = savedConvId;
                updateConversationIdDisplay();
            }
            
            // Focus on input
            document.getElementById('command-input').focus();
        });
        
        // Update current time display
        function updateCurrentTime() {
            const now = new Date();
            const timeStr = now.toLocaleTimeString('en-US', { hour12: false });
            document.getElementById('current-time').textContent = timeStr;
        }
        
        // Check server status
        async function checkServerStatus() {
            try {
                const response = await fetch(apiUrl('health'));
                const data = await response.json();
                
                if (data.status === 'healthy') {
                    document.getElementById('server-status').innerHTML = 'SERVER: <span class="status-connected">CONNECTED</span>';
                    document.getElementById('connection-status').textContent = 'Connected';
                    document.getElementById('connection-status').style.color = '#cccccc';
                    
                    if (data.websocket_connected) {
                        document.getElementById('browser-status').innerHTML = 'BROWSER: <span class="status-connected">CONNECTED</span>';
                    } else {
                        document.getElementById('browser-status').innerHTML = 'BROWSER: <span class="status-disconnected">NOT CONNECTED</span>';
                    }
                } else {
                    document.getElementById('server-status').innerHTML = 'SERVER: <span class="status-disconnected">ERROR</span>';
                    document.getElementById('connection-status').textContent = 'Error';
                    document.getElementById('connection-status').style.color = '#888888';
                }
            } catch (error) {
                document.getElementById('server-status').innerHTML = 'SERVER: <span class="status-disconnected">OFFLINE</span>';
                document.getElementById('connection-status').textContent = 'Offline';
                document.getElementById('connection-status').style.color = '#888888';
                document.getElementById('browser-status').innerHTML = 'BROWSER: <span class="status-disconnected">UNKNOWN</span>';
            }
        }
        
        // Send command to agent
        async function sendCommand() {
            const input = document.getElementById('command-input');
            const command = input.value.trim();
            
            if (!command || isProcessing) {
                return;
            }
            
            // Clear input
            input.value = '';
            
            // Add user command to terminal (if filter allows)
            if (document.getElementById('filter-user-message').checked) {
                addEvent({
                    type: 'MessageEvent',
                    text: `User: ${command}`,
                    timestamp: new Date().toISOString(),
                    source: 'user'
                });
            }
            
            // Disable send button
            isProcessing = true;
            document.getElementById('send-button').disabled = true;
            
            // Create or use existing conversation
            let conversationId = currentConversationId;
            if (!conversationId) {
                try {
                    const response = await fetch(apiUrl('agent/conversations'), {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' }
                    });
                    const data = await response.json();
                    conversationId = data.conversation_id;
                    currentConversationId = conversationId;
                    localStorage.setItem('openbrowser_conversation_id', conversationId);
                    updateConversationIdDisplay();
                } catch (error) {
                    addEvent({
                        type: 'ErrorEvent',
                        text: `Failed to create conversation: ${error.message}`,
                        timestamp: new Date().toISOString()
                    });
                    isProcessing = false;
                    document.getElementById('send-button').disabled = false;
                    return;
                }
            }
            
            // Close existing EventSource if any
            if (eventSource) {
                eventSource.close();
            }
            
            // Setup SSE connection
            setupEventSource(conversationId, command);
        }
        
        // Setup SSE connection for receiving events
        function setupEventSource(conversationId, command) {
            const url = apiUrl(`agent/conversations/${conversationId}/messages`);
            
            eventSource = new EventSource(url, {
                withCredentials: false
            });
            
            // Flag to track if error has been handled
            let errorHandled = false;
            
            // Send the command
            fetch(url, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ text: command })
            }).catch(error => {
                addEvent({
                    type: 'ErrorEvent',
                    text: `Failed to send command: ${error.message}`,
                    timestamp: new Date().toISOString()
                });
                isProcessing = false;
                document.getElementById('send-button').disabled = false;
                eventSource.close();
            });
            
            // Handle incoming events
            eventSource.addEventListener('agent_event', function(event) {
                try {
                    if (event.data && typeof event.data === 'string' && event.data.trim() !== '') {
                        const data = JSON.parse(event.data);
                        processEvent(data);
                    } else {
                        console.error('agent_event received empty or invalid data:', event.data);
                    }
                } catch (error) {
                    console.error('Error parsing agent_event:', error, 'data:', event.data);
                }
            });
            
            eventSource.addEventListener('complete', function(event) {
                try {
                    if (event.data && typeof event.data === 'string' && event.data.trim() !== '') {
                        const data = JSON.parse(event.data);
                        addEvent({
                            type: 'SystemEvent',
                            text: `Conversation completed: ${data.message || 'Done'}`,
                            timestamp: new Date().toISOString()
                        });
                    } else {
                        addEvent({
                            type: 'SystemEvent',
                            text: 'Conversation completed',
                            timestamp: new Date().toISOString()
                        });
                    }
                    
                    // Re-enable send button
                    isProcessing = false;
                    document.getElementById('send-button').disabled = false;
                    
                    // Close EventSource
                    if (eventSource) {
                        eventSource.close();
                        eventSource = null;
                    }
                } catch (error) {
                    console.error('Error parsing complete event:', error, 'data:', event.data);
                    addEvent({
                        type: 'SystemEvent',
                        text: 'Conversation completed with error',
                        timestamp: new Date().toISOString()
                    });
                    isProcessing = false;
                    document.getElementById('send-button').disabled = false;
                }
            });
            
            eventSource.addEventListener('error', function(event) {
                try {
                    // Mark error as handled
                    errorHandled = true;
                    
                    // Check if event.data exists and is a non-empty string (not undefined/null)
                    if (event.data && typeof event.data === 'string' && event.data.trim() !== '') {
                        // Try to parse as JSON if it doesn't look like a simple string
                        if (event.data.trim().startsWith('{') && event.data.trim().endsWith('}')) {
                            const data = JSON.parse(event.data);
                            addEvent({
                                type: 'ErrorEvent',
                                text: `Error: ${data.error || data.message || 'Unknown error'}`,
                                timestamp: new Date().toISOString()
                            });
                        } else {
                            // If it's a string but not JSON, show it as-is
                            addEvent({
                                type: 'ErrorEvent',
                                text: `Error: ${event.data}`,
                                timestamp: new Date().toISOString()
                            });
                        }
                    } else {
                        // Generic SSE error when event.data is undefined, null, or empty
                        addEvent({
                            type: 'ErrorEvent',
                            text: 'SSE connection error',
                            timestamp: new Date().toISOString()
                        });
                    }
                    
                    // Re-enable send button
                    isProcessing = false;
                    document.getElementById('send-button').disabled = false;
                    
                    // Close EventSource
                    if (eventSource) {
                        eventSource.close();
                        eventSource = null;
                    }
                } catch (error) {
                    console.error('Error parsing error event:', error);
                    addEvent({
                        type: 'ErrorEvent',
                        text: `SSE Error: ${error.message}`,
                        timestamp: new Date().toISOString()
                    });
                }
            });
            
            // Handle connection errors
            eventSource.onerror = function(error) {
                console.error('EventSource error:', error);
                
                // Skip if error already handled by error event listener
                if (errorHandled) {
                    return;
                }
                
                // Mark error as handled
                errorHandled = true;
                
                // Re-enable send button
                isProcessing = false;
                document.getElementById('send-button').disabled = false;
                
                // Close EventSource
                if (eventSource) {
                    eventSource.close();
                    eventSource = null;
                }
            };
        }
        
        // Process incoming event
        function processEvent(data) {
            // Apply filtering rules
            const eventType = data.type;
            
            // Skip SystemPromptEvent entirely (not shown at all)
            if (eventType === 'SystemPromptEvent') {
                return;
            }
            
            // Skip MessageEvent from user (we already show user input separately)
            if (eventType === 'MessageEvent' && data.text && data.text.includes('user:')) {
                return;
            }
            
            // Create event object
            const event = {
                id: `event-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`,
                type: eventType,
                text: data.text || '',
                timestamp: data.timestamp || new Date().toISOString(),
                image: data.image || null,
                success: data.success,
                message: data.message,
                error: data.error,
                source: data.text && data.text.includes('user:') ? 'user' : 'agent'
            };
            
            // Add to events array
            events.push(event);
            
            // Update counters
            updateEventCounters(eventType);
            
            // Render event
            addEvent(event);
        }
        
        // Update event counters and display
        function updateEventCounters(eventType) {
            eventCounters.total++;
            
            switch (eventType) {
                case 'MessageEvent':
                    eventCounters.message++;
                    break;
                case 'ActionEvent':
                    eventCounters.action++;
                    break;
                case 'ObservationEvent':
                    eventCounters.observation++;
                    break;
                case 'ErrorEvent':
                    eventCounters.error++;
                    break;
            }
            
            // Update display
            document.getElementById('event-count').innerHTML = `EVENTS: <span>${eventCounters.total}</span>`;
            document.getElementById('stat-total').textContent = eventCounters.total;
            document.getElementById('stat-message').textContent = eventCounters.message;
            document.getElementById('stat-action').textContent = eventCounters.action;
            document.getElementById('stat-observation').textContent = eventCounters.observation;
            document.getElementById('stat-error').textContent = eventCounters.error;
        }
        
        // Add event to terminal display
        function addEvent(event) {
            const terminalOutput = document.getElementById('terminal-output');
            
            // Create event line
            const eventLine = document.createElement('div');
            eventLine.className = 'event-line collapsed';
            eventLine.id = event.id;
            eventLine.dataset.type = event.type;
            eventLine.dataset.source = event.source || 'system';
            
            // Determine event type color
            let typeColor = '#666666'; // Default system color
            if (event.type === 'MessageEvent') {
                typeColor = event.source === 'user' ? '#aaaaaa' : '#cccccc';
            } else if (event.type === 'ActionEvent') {
                typeColor = '#aaaaaa';
            } else if (event.type === 'ObservationEvent') {
                typeColor = '#aaaaaa';
            } else if (event.type === 'ErrorEvent') {
                typeColor = '#888888';
            }
            
            // Format timestamp
            const timestamp = new Date(event.timestamp);
            const timeStr = timestamp.toLocaleTimeString('en-US', { hour12: false });
            
            // Build content
            let content = event.text || event.message || '';
            if (event.error) {
                content = `ERROR: ${event.error}`;
            }
            
            // Create HTML
            eventLine.innerHTML = `
                <div class="event-header">
                    <span class="event-type" style="color: ${typeColor}">${event.type.replace('Event', '').toUpperCase()}</span>
                    <span class="event-timestamp">${timeStr}</span>
                    <span class="expand-toggle" onclick="toggleEvent(this)">[expand]</span>
                </div>
                <div class="event-content">
                    ${formatContent(content)}
                    ${event.image ? `<img class="event-image" src="${event.image}" alt="Screenshot" onload="this.parentElement.parentElement.classList.add('has-image')">` : ''}
                </div>
            `;
            
            // Apply filter visibility
            updateEventVisibility(eventLine);
            
            // Add to terminal
            terminalOutput.appendChild(eventLine);
            
            // Auto-expand if setting is enabled
            const autoExpand = document.getElementById('auto-expand').checked;
            if (autoExpand) {
                expandEvent(eventLine);
            }
            
            // Scroll to bottom
            terminalOutput.scrollTop = terminalOutput.scrollHeight;
            
            return eventLine;
        }
        
        // Format content for display
        function formatContent(content) {
            if (!content) return '';
            
            // Convert line breaks
            content = content.replace(/\n/g, '<br>');
            
            // Add prompt style to lines that start with certain patterns
            content = content.replace(/^(\s*)(>|\$|#)/gm, '$1<span class="prompt-line">$2</span>');
            
            return content;
        }
        
        // Toggle event expansion
        function toggleEvent(toggleElement) {
            const eventLine = toggleElement.closest('.event-line');
            if (eventLine.classList.contains('collapsed')) {
                expandEvent(eventLine);
            } else {
                collapseEvent(eventLine);
            }
        }
        
        // Expand event
        function expandEvent(eventLine) {
            eventLine.classList.remove('collapsed');
            eventLine.classList.add('expanded');
            const toggle = eventLine.querySelector('.expand-toggle');
            if (toggle) {
                toggle.textContent = '[collapse]';
            }
        }
        
        // Collapse event
        function collapseEvent(eventLine) {
            eventLine.classList.remove('expanded');
            eventLine.classList.add('collapsed');
            const toggle = eventLine.querySelector('.expand-toggle');
            if (toggle) {
                toggle.textContent = '[expand]';
            }
        }
        
        // Update event visibility based on filter settings
        function updateEventVisibility(eventLine = null) {
            const showSystem = document.getElementById('filter-system').checked;
            const showUserMessages = document.getElementById('filter-user-message').checked;
            
            if (eventLine) {
                // Update single event
                const eventType = eventLine.dataset.type;
                const eventSource = eventLine.dataset.source;
                
                let shouldShow = true;
                
                if (eventType.includes('System')) {
                    shouldShow = showSystem;
                } else if (eventType === 'MessageEvent' && eventSource === 'user') {
                    shouldShow = showUserMessages;
                }
                
                eventLine.classList.toggle('hidden', !shouldShow);
            } else {
                // Update all events
                document.querySelectorAll('.event-line').forEach(line => {
                    const eventType = line.dataset.type;
                    const eventSource = line.dataset.source;
                    
                    let shouldShow = true;
                    
                    if (eventType.includes('System')) {
                        shouldShow = showSystem;
                    } else if (eventType === 'MessageEvent' && eventSource === 'user') {
                        shouldShow = showUserMessages;
                    }
                    
                    line.classList.toggle('hidden', !shouldShow);
                });
            }
        }
        
        // Set command in input field
        function setCommand(command) {
            document.getElementById('command-input').value = command;
            document.getElementById('command-input').focus();
        }
        
        // Clear terminal
        function clearTerminal() {
            const terminalOutput = document.getElementById('terminal-output');
            
            // Keep only the first system message
            const allEvents = terminalOutput.querySelectorAll('.event-line');
            for (let i = 1; i < allEvents.length; i++) {
                allEvents[i].remove();
            }
            
            // Clear events array and counters
            events = [];
            resetEventCounters();
            
            // Add clear message
            addEvent({
                type: 'SystemEvent',
                text: 'Terminal cleared.',
                timestamp: new Date().toISOString()
            });
        }
        
        // Reset event counters
        function resetEventCounters() {
            eventCounters = {
                total: 0,
                message: 0,
                action: 0,
                observation: 0,
                error: 0
            };
            
            // Update display
            document.getElementById('event-count').innerHTML = 'EVENTS: <span>0</span>';
            document.getElementById('stat-total').textContent = '0';
            document.getElementById('stat-message').textContent = '0';
            document.getElementById('stat-action').textContent = '0';
            document.getElementById('stat-observation').textContent = '0';
            document.getElementById('stat-error').textContent = '0';
        }
        
        // Update conversation ID display
        function updateConversationIdDisplay() {
            const display = document.getElementById('conversation-id');
            if (currentConversationId) {
                const shortId = currentConversationId.substring(0, 8) + '...';
                display.textContent = shortId;
                display.title = currentConversationId;
            } else {
                display.textContent = 'None';
                display.title = '';
            }
        }
    </script>
</body>
</html>